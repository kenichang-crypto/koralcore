# Entity ID 類型設計說明

本文檔說明 `koralcore` 中 Entity ID 類型的設計選擇和與 `reef-b-app` 的對照。

生成時間：2025-01-XX

---

## 一、ID 類型對照表

| Entity | reef-b-app | koralcore | 說明 |
|--------|------------|-----------|------|
| Device | Int | String | koralcore 使用 String 以支持更靈活的 ID 生成策略 |
| Scene | Int | String | koralcore 使用 String 以支持更靈活的 ID 生成策略 |
| DropHead | Int | String (headId) | koralcore 使用 headId (String) 作為標識，如 'A', 'B', 'C', 'D' |
| Sink | Int | String | koralcore 使用 String 以支持更靈活的 ID 生成策略 |
| DropType | Int | int | ✅ 完全一致 |
| LedRecord | N/A | String | koralcore 使用 String 作為記錄 ID |
| Warning | Int | int | ✅ 完全一致 |

---

## 二、設計原則

### 1. String ID 的優勢

**使用 String ID 的 Entity：**
- Device
- Scene
- Sink
- LedRecord

**原因：**
1. **靈活性**：支持多種 ID 生成策略（UUID、時間戳、自定義格式）
2. **跨平台兼容**：不同平台可能有不同的 ID 生成方式
3. **可讀性**：String ID 可以包含語義信息（如 `preset_01`）
4. **無需自增**：不依賴數據庫的自增功能，適合分佈式場景

### 2. Int ID 的優勢

**使用 Int ID 的 Entity：**
- DropType
- Warning

**原因：**
1. **數據庫兼容**：與 `reef-b-app` 的 Room 數據庫完全兼容
2. **簡單性**：對於簡單的實體，Int ID 足夠使用
3. **性能**：Int 比較和索引性能更好
4. **序列化**：JSON 序列化更簡單

---

## 三、具體 Entity 說明

### Device

**reef-b-app**: `Int` (auto-generated)
**koralcore**: `String`

**設計選擇**：
- koralcore 使用 String ID 以支持設備 MAC 地址作為 ID，或使用 UUID
- 這樣可以避免依賴數據庫自增，更適合跨平台場景

**對照**：
- `reef-b-app`: `id: Int = 0` (auto-generated by Room)
- `koralcore`: `id: String` (可以是 MAC 地址、UUID 或其他格式)

---

### Scene

**reef-b-app**: `Int` (auto-generated)
**koralcore**: `String`

**設計選擇**：
- koralcore 使用 String ID 以支持預設場景 ID（如 `preset_01`）
- 這樣可以區分預設場景和自定義場景

**對照**：
- `reef-b-app`: `id: Int = 0` (auto-generated by Room)
- `koralcore`: `sceneId: String` (可以是 `preset_01` 或自定義 ID)

---

### DropHead / PumpHead

**reef-b-app**: `Int` (headId: Int, 1-4)
**koralcore**: `String` (headId: String, 'A'-'D')

**設計選擇**：
- koralcore 使用 String headId ('A', 'B', 'C', 'D') 以提升可讀性
- 在 Repository 層可以轉換為 Int 用於 BLE 通信

**對照**：
- `reef-b-app`: `headId: Int` (1, 2, 3, 4)
- `koralcore`: `headId: String` ('A', 'B', 'C', 'D')
- **轉換**：`PumpHeadRepository.pumpIdFromHeadId()` 提供轉換邏輯

---

### Sink

**reef-b-app**: `Int` (auto-generated)
**koralcore**: `String`

**設計選擇**：
- koralcore 使用 String ID 以支持默認 Sink ID（如 `default-sink`）
- 這樣可以區分默認 Sink 和自定義 Sink

**對照**：
- `reef-b-app`: `id: Int = 0` (auto-generated by Room)
- `koralcore`: `id: String` (可以是 `default-sink` 或自定義 ID)

---

### DropType

**reef-b-app**: `Int` (auto-generated)
**koralcore**: `int`

**設計選擇**：
- ✅ 完全一致，使用 Int ID
- 原因：DropType 是簡單的實體，不需要複雜的 ID 策略

**對照**：
- `reef-b-app`: `id: Int = 0` (auto-generated by Room)
- `koralcore`: `id: int` (auto-generated by SQLite)

---

### Warning

**reef-b-app**: `Int` (auto-generated)
**koralcore**: `int`

**設計選擇**：
- ✅ 完全一致，使用 Int ID
- 原因：Warning 是簡單的實體，不需要複雜的 ID 策略

**對照**：
- `reef-b-app`: `id: Int = 0` (auto-generated by Room)
- `koralcore`: `id: int` (auto-generated by SQLite)

---

## 四、序列化兼容性

### Warning 的序列化兼容

雖然 `Warning.time` 在 koralcore 中使用 `DateTime`，但在序列化時會轉換為 String 以兼容 `reef-b-app`：

```dart
// koralcore Warning.toJson()
{
  'id': 1,
  'warning_id': 100,
  'device_mac_address': 'AA:BB:CC:DD:EE:FF',
  'time': '2025-01-15 14:30:00'  // DateTime 轉換為 String
}
```

```dart
// koralcore Warning.fromJson() 可以解析
{
  'id': 1,
  'warning_id': 100,
  'device_mac_address': 'AA:BB:CC:DD:EE:FF',
  'time': '2025-01-15 14:30:00'  // String 轉換為 DateTime
}
```

---

## 五、遷移建議

### 從 reef-b-app 遷移到 koralcore

1. **Device ID 遷移**：
   - 使用 MAC 地址作為 String ID
   - 或使用映射表將 Int ID 轉換為 String ID

2. **Scene ID 遷移**：
   - 預設場景：使用 `preset_${code}` 格式
   - 自定義場景：使用 UUID 或時間戳

3. **Sink ID 遷移**：
   - 默認 Sink：使用 `default-sink`
   - 自定義 Sink：使用 UUID 或時間戳

4. **DropHead ID 遷移**：
   - 使用 `PumpHeadRepository.pumpIdFromHeadId()` 進行轉換
   - Int (1-4) → String ('A'-'D')

---

## 六、總結

### ID 類型選擇原則

1. **使用 String ID**：當需要靈活性、跨平台兼容性或語義信息時
2. **使用 Int ID**：當實體簡單、需要數據庫兼容性或性能優先時

### 兼容性保證

- ✅ 所有 Entity 都提供 JSON 序列化/反序列化方法
- ✅ Warning 支持 String 和 DateTime 格式的 time 字段
- ✅ 所有 ID 轉換邏輯都封裝在 Repository 層

### 未來考慮

- 考慮統一使用 String ID 以簡化架構
- 或提供 ID 類型轉換工具類以支持遷移

